<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ArvidsonFoto.se – Navmeny Preview (flip, no-leak, bigger toggle)</title>
  <style>
    :root{
      --bar-h: 54px;
      --bar-bg: #0f1113;
      --bar-fg: #f3f5f7;
      --muted: #aab2bd;
      --accent: #8bc34a;
      --submenu-bg: #f1f3f5;
      --submenu-fg: #212529;
      --submenu-border: #dfe3e6;
      --shadow: 0 8px 24px rgba(0,0,0,.2);
      --radius: 8px;
      --speed: 160ms;
      --z-header: 1000;
      --z-backdrop: 900;

      /* Mobile toggle hit area */
      --toggle-touch: 68px;   /* wider */
      --toggle-height: 46px;  /* taller */
      --submenu-gap: -2px;    /* overlap slightly to prevent hover loss */
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }
    body { font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; color: #e7eaee; background:#0b0d10; }
    .sr-only { position: absolute !important; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    /* Header / Bar */
    .site-header { position: sticky; top: 0; z-index: var(--z-header); background: var(--bar-bg); color: var(--bar-fg); box-shadow: 0 1px 0 rgba(255,255,255,.04); }
    .site-header .bar { height: var(--bar-h); display: grid; grid-template-columns: auto max-content; align-items: center; gap: 12px; padding: 0 16px; max-width: 1280px; margin-inline: auto; }
    .brand { color: var(--bar-fg); text-decoration: none; font-weight: 600; letter-spacing: .2px; }

    /* Hamburger (mobile) */
    .menu-toggle { display: none; place-self: center end; background: transparent; border: 0; padding: 8px; margin: -8px; cursor: pointer; color: var(--bar-fg); }
    .menu-toggle-box { display: inline-grid; gap: 4px; }
    .menu-toggle .line { width: 22px; height: 2px; background: currentColor; display: block; border-radius: 2px; }

    /* Nav / Menus */
    .main-nav { position: relative; }
    .menu { list-style: none; margin: 0; padding: 0; display: flex; align-items: stretch; gap: 4px; }
    .menu > .menu-item > a { display: inline-flex; align-items: center; height: var(--bar-h); padding: 0 12px; color: var(--bar-fg); text-decoration: none; font-weight: 500; }
    .menu > .menu-item > a:hover, .menu > .menu-item > a:focus-visible { background: rgba(255,255,255,.06); outline: none; }
    .menu > .menu-item.has-submenu > a::after { content: "▾"; margin-left: 6px; font-size: 0.8em; opacity: .7; }

    /* Hide mobile "+" buttons by default (desktop) */
    .submenu-toggle { display: none !important; }

    /* Submenus (desktop baseline) */
    .submenu {
      list-style: none; margin: 0; padding: 8px;
      position: absolute; left: 0; top: calc(100% - 2px);
      min-width: 260px; background: var(--submenu-bg); color: var(--submenu-fg);
      border: 1px solid var(--submenu-border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: none;
      z-index: 10; /* base layer */
    }
    
    /* For very long submenus like Fjärilar, make them scrollable within viewport */
    .submenu.large-menu {
      min-width: 280px; /* Standard width, not too wide */
      max-width: 320px;
      max-height: 70vh; /* Stay within viewport height */
      position: relative; /* For scroll arrows positioning */
      padding: 0; /* Remove default padding, add to scroll area instead */
      
      /* Custom scrollbar for better appearance */
      scrollbar-width: thin;
      scrollbar-color: #aaa transparent;
    }
    
    /* Create a scrollable inner container for menu items */
    .submenu.large-menu {
      display: flex;
      flex-direction: column;
    }
    
    /* Fixed scroll arrows */
    .submenu.large-menu::before,
    .submenu.large-menu::after {
      content: '';
      position: relative;
      height: 20px;
      background: var(--submenu-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      color: #666;
      cursor: pointer;
      z-index: 2;
      pointer-events: auto;
      opacity: 0;
      transition: opacity 0.2s ease;
      flex-shrink: 0; /* Don't shrink these elements */
    }
    
    /* Up arrow - fixed at top */
    .submenu.large-menu::before {
      content: '▲';
      border-bottom: 1px solid var(--submenu-border);
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
    }
    
    /* Down arrow - fixed at bottom */
    .submenu.large-menu::after {
      content: '▼';
      border-top: 1px solid var(--submenu-border);
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
    }
    
    /* Scrollable content area between arrows */
    .submenu.large-menu .menu-items-container {
      flex: 1;
      overflow-y: auto;
      scroll-behavior: smooth;
      padding: 8px; /* Move padding here from parent */
    }
    
    /* Show arrows when menu is hovered and scrollable */
    .submenu.large-menu:hover::before,
    .submenu.large-menu:hover::after {
      opacity: 1;
    }
    
    /* Hide up arrow when at top, down arrow when at bottom */
    .submenu.large-menu.at-top::before {
      opacity: 0 !important;
    }
    
    .submenu.large-menu.at-bottom::after {
      opacity: 0 !important;
    }
    
    /* Webkit scrollbar styling for the scrollable container */
    .submenu.large-menu .menu-items-container::-webkit-scrollbar {
      width: 6px;
    }
    .submenu.large-menu .menu-items-container::-webkit-scrollbar-track {
      background: transparent;
    }
    .submenu.large-menu .menu-items-container::-webkit-scrollbar-thumb {
      background: #aaa;
      border-radius: 3px;
    }
    .submenu.large-menu .menu-items-container::-webkit-scrollbar-thumb:hover {
      background: #888;
    }
    
    /* Remove column layout - keep items in single column for better scrolling */
    .submenu.large-menu .menu-item {
      break-inside: auto;
      page-break-inside: auto;
    }
    
    /* Show large menus in columns on hover/focus (desktop with mouse) */
    @media (hover: hover) and (pointer: fine) {
      /* Only show large menus when hovering directly over their parent, not grandparent */
      .submenu .menu-item.has-submenu:hover > .submenu.large-menu { 
        display: flex; 
        left: calc(100% + var(--submenu-gap)); 
        top: -8px; 
        position: absolute; /* Ensure it doesn't expand parent menu */
      }
    }
    /* raise z-index for deeper levels to prevent overlap bleed */
    .submenu .submenu { z-index: 11; }
    .submenu .submenu .submenu { z-index: 12; }
    .submenu .submenu .submenu .submenu { z-index: 13; }

    .menu-item.has-submenu { position: relative; }
    .menu-item .submenu .menu-item { position: relative; }

    .submenu .menu-item > a {
      display: flex; align-items: center;
      min-height: 40px; padding: 8px 12px; border-radius: 6px;
      color: var(--submenu-fg); text-decoration: none;
      white-space: nowrap; /* prevent wrapping causing overlap */
    }
    .submenu .menu-item > a:hover, .submenu .menu-item > a:focus-visible { background: #e7eaee; outline: none; color:#111; }
    .submenu .menu-item.has-submenu > a::after { content: "▸"; margin-left: auto; color: #6b7280; }

    /* Show on hover/focus (desktop with mouse) and add gap */
    @media (hover: hover) and (pointer: fine) and (min-width: 961px) {
      .menu > .menu-item.has-submenu:hover > .submenu { display: block; }
      .submenu .menu-item.has-submenu:hover > .submenu:not(.large-menu) { 
        display: block; 
        left: calc(100% + var(--submenu-gap)); 
        top: -8px; 
      }
      
      /* IMPORTANT: Override .open class rules with higher specificity for hover */
      .submenu .menu-item.has-submenu:hover > .submenu.large-menu { 
        display: flex !important; 
        left: calc(100% + var(--submenu-gap)) !important; 
        top: -8px !important; 
        position: absolute !important; 
      }
      
      /* Ensure hover rules take precedence over .open class - DESKTOP ONLY */
      .submenu .menu-item.has-submenu:not(:hover) > .submenu.large-menu { 
        display: none !important; 
      }
      
      /* Add hover tolerance - keep parent menus open when hovering near submenus */
      .menu-item.has-submenu::before {
        content: '';
        position: absolute;
        top: -4px;
        right: -4px;
        bottom: -4px;
        left: -4px;
        z-index: -1;
        pointer-events: auto;
      }
      
      /* Extend hover area for nested submenus to prevent closing */
      .submenu .menu-item.has-submenu::after {
        content: '';
        position: absolute;
        top: 0;
        right: -6px;
        bottom: 0;
        width: 6px;
        pointer-events: auto;
        z-index: 1;
      }
    }

    /* Desktop explicit tap-open and flipping logic */
    @media (min-width: 961px) and (hover: hover) and (pointer: fine) {
      .menu-item.open > .submenu { display: block; }
      .menu-item.open > .submenu.large-menu { display: flex; }
      .submenu .menu-item.open > .submenu { display: block; left: calc(100% + var(--submenu-gap)); top: -8px; }
      .submenu .menu-item.open > .submenu.large-menu { display: flex; left: calc(100% + var(--submenu-gap)); top: -8px; position: absolute; }

      /* Flip rules */
      .menu-item.open-left > .submenu { left: auto; right: 0; } /* top-level dropdown flip */
      .menu-item.open-left > .submenu.large-menu { left: auto; right: 0; } /* large menu flip */
      .submenu .menu-item.open-left > .submenu { left: auto; right: calc(100% + var(--submenu-gap)); }
      .submenu .menu-item.open-left > .submenu.large-menu { left: auto; right: calc(100% + var(--submenu-gap)); }
      .submenu .menu-item.open-left > a::after { content: "◂"; }
    }

    /* Search */
    .menu > .search { margin-left: auto; display: flex; align-items: center; }
    .search-form input[type="search"]{
      height: 34px; border-radius: 999px; border: 1px solid #3a3f44; outline: none;
      background: #171a1d; color: var(--bar-fg); padding: 0 12px; width: 180px;
    }
    .search-form input::placeholder { color: var(--muted); }

    /* Mobile / small screens */
    @media (max-width: 960px) {
      .menu-toggle { display: inline-grid; }
      .site-header .bar { grid-template-columns: 1fr max-content; }

      .main-nav {
        position: fixed; inset: var(--bar-h) 0 0 0; background: var(--bar-bg);
        transform: translateY(-8px); opacity: 0; pointer-events: none;
        transition: transform var(--speed) ease, opacity var(--speed) ease;
        overflow-y: auto; z-index: calc(var(--z-backdrop) + 1);
      }
      .site-header.nav-open .main-nav { transform: translateY(0); opacity: 1; pointer-events: auto; }

      .site-header .backdrop { position: fixed; inset: var(--bar-h) 0 0 0; background: rgba(0,0,0,.4); z-index: var(--z-backdrop); }
      .site-header .backdrop[hidden] { display: none; }

      .menu { display: block; padding: 8px 10px 32px; }
      .menu > .menu-item > a {
        height: auto; padding: 12px 12px;
        border-radius: 8px;
      }
      .menu > .menu-item + .menu-item { margin-top: 4px; }

      /* Hide all desktop chevrons in mobile (force) */
      .menu > .menu-item.has-submenu > a::after,
      .submenu .menu-item.has-submenu > a::after { display: none !important; content: none !important; }

      /* Reserve space on the right for the toggle to avoid accidental link taps */
      .menu > .menu-item.has-submenu > a,
      .submenu .menu-item.has-submenu > a {
        padding-right: calc(var(--toggle-touch) + 20px);
        position: relative; /* Ensure proper stacking context for button positioning */
      }

      /* Accordion behavior: height animation; collapsed state completely hidden (no leak) */
      .submenu-toggle {
        position: absolute; right: -5px; top: -2px; z-index: 15;
        background: #262a2f; color: var(--bar-fg);
        border: 1px solid #343a40; border-radius: 12px;
        width: calc(var(--toggle-touch) + 10px); height: var(--toggle-height);
        display: grid !important; place-items: center;
        touch-action: manipulation;
        pointer-events: auto; /* Ensure button is clickable */
        padding: 1em; /* Increase touch area for easier tapping */
      }
      
      /* Ensure parent menu items maintain positioning context for buttons */
      .menu-item.has-submenu {
        position: relative;
      }
      
      /* Prevent parent link from being clickable in the button area */
      .menu-item.has-submenu > a {
        pointer-events: auto; /* Parent link clickable */
        position: relative;
        z-index: 2; /* Below button but above submenu */
      }
      
      .menu-item.has-submenu > a::before {
        content: '';
        position: absolute;
        right: 0;
        top: 0;
        bottom: 0;
        width: calc(var(--toggle-touch) + 20px);
        pointer-events: none; /* Block parent clicks in button area */
        z-index: -1;
      }
      .submenu-toggle .icon { transition: transform var(--speed); font-size: 18px; }
      .menu-item.expanded > .submenu-toggle .icon { transform: rotate(45deg); }

      .menu-item .submenu {
        position: static; display: block; background: #111418; color: var(--bar-fg);
        height: 0; overflow: hidden; transition: height 220ms ease; will-change: height;

        /* Collapsed: ensure no artifacts/lines */
        padding: 0; margin: 0; border: 0; border-left-width: 0;
        visibility: hidden; pointer-events: none;
        contain: layout paint;  /* avoid subpixel leaks */
        
        /* Reset column layout for mobile */
        column-count: 1;
        min-width: auto;
        max-width: none;
        max-height: none;
      }
      
      /* Reset large-menu flexbox layout for mobile - make it behave like normal submenu */
      .menu-item .submenu.large-menu {
        display: block !important; /* Override flex display strongly */
        flex-direction: initial;
        position: static !important; /* Reset positioning */
        min-width: auto !important;
        max-width: none !important;
        max-height: none !important;
        left: auto !important;
        top: auto !important;
        transform: none !important;
      }
      
      /* Reset the container wrapper for mobile - make it behave normally */
      .menu-item .submenu.large-menu .menu-items-container {
        padding: 0; /* Remove desktop padding */
        overflow-y: visible; /* Remove desktop scrolling */
        flex: none; /* Remove flex behavior */
        display: block; /* Ensure normal block display */
      }
      
      /* Hide scroll arrows on mobile */
      .menu-item .submenu.large-menu::before,
      .menu-item .submenu.large-menu::after {
        display: none;
      }
      /* Expanded spacing restored and visible */
      .menu-item.expanded > .submenu {
        padding: 4px; margin: 4px 0 8px 8px; border-left: 2px solid #2a2f35;
        visibility: visible; pointer-events: auto;
      }

      .submenu .menu-item > a { color: #d9dde2; padding: 10px 10px; border-radius: 6px; }
    }

    /* Desktop: reset submenu colors back to proper light background scheme */
    @media (min-width: 961px) {
      /* Reset main menu items to proper desktop colors */
      .menu > .menu-item > a {
        color: var(--bar-fg) !important; /* Ensure proper light text on dark background */
      }
      
      /* Reset submenu items to proper desktop colors */
      .submenu .menu-item > a { 
        color: var(--submenu-fg) !important; /* Reset to dark text for light backgrounds */
      }
    }

    /* Active state hint */
    .menu > .menu-item > a[aria-current="page"],
    .submenu .menu-item > a[aria-current="page"] { color: var(--accent); }

    /* Demo content area */
    .content { max-width: 1000px; margin: 24px auto; padding: 0 16px; }
    .card { background:#111418; border:1px solid #23272f; border-radius:12px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.2); margin: 12px 0; }
    .demo-spacer { height: 900px; }
  </style>
</head>
<body>
  <header class="site-header" role="banner">
    <div class="bar">
      <a class="brand" href="/" aria-label="ArvidsonFoto.se">ArvidsonFoto.se</a>

      <button id="menu-toggle" class="menu-toggle" aria-controls="main-menu" aria-expanded="false" aria-label="Öppna huvudmeny">
        <span class="menu-toggle-box" aria-hidden="true">
          <span class="line"></span><span class="line"></span><span class="line"></span>
        </span>
      </button>

      <nav class="main-nav" role="navigation" aria-label="Huvudmeny">
        <ul id="main-menu" class="menu">
          <li class="menu-item"><a href="#" aria-current="page">Senast</a></li>

          <li class="menu-item has-submenu">
            <a aria-haspopup="true" aria-expanded="false" href="#">Fåglar</a>
            <ul class="submenu" aria-label="Fåglar">
              <li class="menu-item"><a href="#">Alkor och labbar</a></li>
              <li class="menu-item"><a href="#">Dagrovfåglar</a></li>
              <li class="menu-item"><a href="#">Doppingar och skarvar</a></li>
              <li class="menu-item"><a href="#">Gäss</a></li>
              <li class="menu-item"><a href="#">Hackspettar</a></li>
              <li class="menu-item"><a href="#">Kråkfåglar</a></li>
              <li class="menu-item has-submenu">
                <a aria-haspopup="true" aria-expanded="false" href="#">Tättingar</a>
                <ul class="submenu" aria-label="Tättingar">
                  <li class="menu-item"><a href="#">Finkar och siskor</a></li>
                  <li class="menu-item has-submenu">
                    <a aria-haspopup="true" aria-expanded="false" href="#">Flugsnappare</a>
                    <ul class="submenu" aria-label="Flugsnappare">
                      <li class="menu-item"><a href="#">Grå flugsnappare</a></li>
                      <li class="menu-item"><a href="#">Halsbandsflugsnappare</a></li>
                      <li class="menu-item"><a href="#">Mindre flugsnappare</a></li>
                      <li class="menu-item"><a href="#">Svartvit flugsnappare</a></li>
                    </ul>
                  </li>
                  <li class="menu-item"><a href="#">Lärkor</a></li>
                  <li class="menu-item"><a href="#">Mesar</a></li>
                </ul>
              </li>
              <li class="menu-item"><a href="#">Vadare</a></li>
              <li class="menu-item"><a href="#">Änder</a></li>
            </ul>
          </li>

          <li class="menu-item has-submenu">
            <a aria-haspopup="true" aria-expanded="false" href="#">Däggdjur</a>
            <ul class="submenu" aria-label="Däggdjur">
              <li class="menu-item"><a href="#">Rovdjur</a></li>
              <li class="menu-item"><a href="#">Hjortdjur</a></li>
            </ul>
          </li>

          <li class="menu-item has-submenu">
            <a aria-haspopup="true" aria-expanded="false" href="#">Insekter</a>
            <ul class="submenu" aria-label="Insekter">
              <li class="menu-item has-submenu">
                <a aria-haspopup="true" aria-expanded="false" href="#">Fjärilar</a>
                <ul class="submenu large-menu" aria-label="Fjärilar">
                  <div class="menu-items-container">
                    <li class="menu-item"><a href="#">Alkonblåvinge</a></li>
                    <li class="menu-item"><a href="#">Allmän poppelglasvinge</a></li>
                    <li class="menu-item"><a href="#">Almsnabbvinge</a></li>
                    <li class="menu-item"><a href="#">Amiral</a></li>
                    <li class="menu-item"><a href="#">Apollofjäril</a></li>
                    <li class="menu-item"><a href="#">Asknätfjäril</a></li>
                    <li class="menu-item"><a href="#">Aspfjäril</a></li>
                    <li class="menu-item"><a href="#">Aspskimmerfjäril</a></li>
                    <li class="menu-item"><a href="#">Aurorafjäril</a></li>
                    <li class="menu-item"><a href="#">Berggräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Blåfläckig träfjäril</a></li>
                    <li class="menu-item"><a href="#">Bredbrämad bastardsvärmare</a></li>
                    <li class="menu-item"><a href="#">Brun björnspinnare</a></li>
                    <li class="menu-item"><a href="#">Brun blåvinge</a></li>
                    <li class="menu-item"><a href="#">Brun gräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Brunfläckig pärlemorfjäril</a></li>
                    <li class="menu-item"><a href="#">Brunsprötad skymningssvärmare</a></li>
                    <li class="menu-item"><a href="#">Busksnabbvinge</a></li>
                    <li class="menu-item"><a href="#">Citronfjäril</a></li>
                    <li class="menu-item"><a href="#">Dårgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Eksnabbvinge</a></li>
                    <li class="menu-item"><a href="#">Ekspinnare</a></li>
                    <li class="menu-item"><a href="#">Eldsnabbvinge</a></li>
                    <li class="menu-item"><a href="#">Fetörtsblåvinge</a></li>
                    <li class="menu-item"><a href="#">Fjällbastardsvärmare</a></li>
                    <li class="menu-item"><a href="#">Fjällgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Fjällhöfjäril</a></li>
                    <li class="menu-item"><a href="#">Fjällpärlemorfjäril</a></li>
                    <li class="menu-item"><a href="#">Fjällvickerblåvinge</a></li>
                    <li class="menu-item"><a href="#">Gräsulv</a></li>
                    <li class="menu-item"><a href="#">Grönfläckig vitfjäril</a></li>
                    <li class="menu-item"><a href="#">Grönsnabbvinge</a></li>
                    <li class="menu-item"><a href="#">Gullvivefjäril</a></li>
                    <li class="menu-item"><a href="#">Hagtornsfjäril</a></li>
                    <li class="menu-item"><a href="#">Hedpärlemofjäril</a></li>
                    <li class="menu-item"><a href="#">Humlelik dagsvärmare</a></li>
                    <li class="menu-item"><a href="#">Kamgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Karminspinnare</a></li>
                    <li class="menu-item"><a href="#">Kartfjäril</a></li>
                    <li class="menu-item"><a href="#">Kattunvisslare</a></li>
                    <li class="menu-item"><a href="#">Klubbsprötad bastardsvärmare</a></li>
                    <li class="menu-item"><a href="#">Klöverblåvinge</a></li>
                    <li class="menu-item"><a href="#">Krattsnabbvinge</a></li>
                    <li class="menu-item"><a href="#">Kvickgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Körsbärsfux</a></li>
                    <li class="menu-item"><a href="#">Kålfjäril</a></li>
                    <li class="menu-item"><a href="#">Ligustersvärmare</a></li>
                    <li class="menu-item"><a href="#">Ljungblåvinge</a></li>
                    <li class="menu-item"><a href="#">Ljusgul höfjäril</a></li>
                    <li class="menu-item"><a href="#">Luktgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Makaonfjäril</a></li>
                    <li class="menu-item"><a href="#">Mindre bastardsvärmare</a></li>
                    <li class="menu-item"><a href="#">Mindre blåvinge</a></li>
                    <li class="menu-item"><a href="#">Mindre guldvinge</a></li>
                    <li class="menu-item"><a href="#">Mindre påfågelspinnare</a></li>
                    <li class="menu-item"><a href="#">Mindre snabelsvärmare</a></li>
                    <li class="menu-item"><a href="#">Mindre tåtelsmygare</a></li>
                    <li class="menu-item"><a href="#">Mnemosynefjäril</a></li>
                    <li class="menu-item"><a href="#">Myrpärlemorfjäril</a></li>
                    <li class="menu-item"><a href="#">Nässelfjäril</a></li>
                    <li class="menu-item"><a href="#">Oxhuvudspinnare</a></li>
                    <li class="menu-item"><a href="#">Poppelsvärmare</a></li>
                    <li class="menu-item"><a href="#">Prydlig pärlemorfjäril</a></li>
                    <li class="menu-item"><a href="#">Puktörneblåvinge</a></li>
                    <li class="menu-item"><a href="#">Pärlgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Påfågelöga</a></li>
                    <li class="menu-item"><a href="#">Rapsfjäril</a></li>
                    <li class="menu-item"><a href="#">Rovfjäril</a></li>
                    <li class="menu-item"><a href="#">Rödfläckig blåvinge</a></li>
                    <li class="menu-item"><a href="#">Sandgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Sexfläckig bastardsvärmare</a></li>
                    <li class="menu-item"><a href="#">Silverblåvinge</a></li>
                    <li class="menu-item"><a href="#">Silversmygare</a></li>
                    <li class="menu-item"><a href="#">Silverstreckad pärlemorfjäril</a></li>
                    <li class="menu-item"><a href="#">Skogsgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Skogsnätfjäril</a></li>
                    <li class="menu-item"><a href="#">Skogspärlemorfjäril</a></li>
                    <li class="menu-item"><a href="#">Skogsvisslare</a></li>
                    <li class="menu-item"><a href="#">Skogsvitvinge</a></li>
                    <li class="menu-item"><a href="#">Slåttergräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Smultronvisslare</a></li>
                    <li class="menu-item"><a href="#">Sorgmantel</a></li>
                    <li class="menu-item"><a href="#">Sotnätfjäril</a></li>
                    <li class="menu-item"><a href="#">Starrgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Stor dagsvärmare</a></li>
                    <li class="menu-item"><a href="#">Storfläckig pärlemorfjäril</a></li>
                    <li class="menu-item"><a href="#">Större snabelsvärmare</a></li>
                    <li class="menu-item"><a href="#">Större träfjäril</a></li>
                    <li class="menu-item"><a href="#">Svartfläckig blåvinge</a></li>
                    <li class="menu-item"><a href="#">Svartfläckig glanssmygare</a></li>
                    <li class="menu-item"><a href="#">Svavelgul höfjäril</a></li>
                    <li class="menu-item"><a href="#">Svingelgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Svävfluglik dagsvärmare</a></li>
                    <li class="menu-item"><a href="#">Sälgskimmerfjäril</a></li>
                    <li class="menu-item"><a href="#">Tallgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Tallprocessionsspinnare</a></li>
                    <li class="menu-item"><a href="#">Tallsvärmare</a></li>
                    <li class="menu-item"><a href="#">Tistelfjäril</a></li>
                    <li class="menu-item"><a href="#">Tosteblåvinge</a></li>
                    <li class="menu-item"><a href="#">Tryfjäril</a></li>
                    <li class="menu-item"><a href="#">Turkos blåvinge</a></li>
                    <li class="menu-item"><a href="#">Tåtelsmygare</a></li>
                    <li class="menu-item"><a href="#">Videfux</a></li>
                    <li class="menu-item"><a href="#">Videsvärmare</a></li>
                    <li class="menu-item"><a href="#">Vinbärsfux</a></li>
                    <li class="menu-item"><a href="#">Vinkelbandat ordensfly</a></li>
                    <li class="menu-item"><a href="#">Violett blåvinge</a></li>
                    <li class="menu-item"><a href="#">Violett guldvinge</a></li>
                    <li class="menu-item"><a href="#">Violettkantad guldvinge</a></li>
                    <li class="menu-item"><a href="#">Vitfläckig guldvinge</a></li>
                    <li class="menu-item"><a href="#">Vitgräsfjäril</a></li>
                    <li class="menu-item"><a href="#">Väddnätfjäril</a></li>
                    <li class="menu-item"><a href="#">Älggräspärlemorfjäril</a></li>
                    <li class="menu-item"><a href="#">Ängsblåvinge</a></li>
                    <li class="menu-item"><a href="#">Ängsmetallvinge</a></li>
                    <li class="menu-item"><a href="#">Ängsnätfjäril</a></li>
                    <li class="menu-item"><a href="#">Ängspärlemorfjäril</a></li>
                    <li class="menu-item"><a href="#">Ängssmygare</a></li>
                    <li class="menu-item"><a href="#">Åkervindesvärmare</a></li>
                  </div>
                </ul>
              </li>
              <li class="menu-item"><a href="#">Trollsländor</a></li>
            </ul>
          </li>

          <li class="menu-item has-submenu">
            <a aria-haspopup="true" aria-expanded="false" href="#">Info</a>
            <ul class="submenu" aria-label="Info">
              <li class="menu-item"><a href="#">Om sidan</a></li>
              <li class="menu-item"><a href="#">Kontakt</a></li>
            </ul>
          </li>

          <li class="menu-item search">
            <form role="search" class="search-form" action="#" method="get">
              <label class="sr-only" for="q">Sök</label>
              <input id="q" name="q" type="search" placeholder="Sök" />
            </form>
          </li>
        </ul>
      </nav>
    </div>
    <div class="backdrop" hidden></div>
  </header>

  <main class="content">
    <div class="card">
      Fixar: (1) Desktop-flyout vänder åt vänster med mellanrum och rätt z-index om annars utanför vyn. (2) Mobil: större +/×, höger sida reserverad för togglen – inga feltryck på länken. (3) Inga linjer/läckage när nivåer stängs.
    </div>
    <div class="demo-spacer"></div>
  </main>

  <script>
    (function () {
      const header = document.querySelector('.site-header');
      const menu = document.getElementById('main-menu');
      const toggle = document.getElementById('menu-toggle');
      const backdrop = document.querySelector('.site-header .backdrop');
      if (!menu) return;

      // Track latest pointer type
      let lastPointerType = 'mouse';
      window.addEventListener('pointerdown', (e) => { if (e.pointerType) lastPointerType = e.pointerType; }, { passive: true });

      const mqMobile = window.matchMedia('(max-width: 960px)');
      const mqCoarse = window.matchMedia('(pointer: coarse)');
      const mqNoHover = window.matchMedia('(hover: none)');

      const isMobile = () => mqMobile.matches;
      const isDesktopLayout = () => !mqMobile.matches;
      const isTouchPrimary = () => lastPointerType === 'touch' || mqCoarse.matches || mqNoHover.matches;

      // Build toggles and ARIA
      let hoverTimeout;
      menu.querySelectorAll('.menu-item.has-submenu').forEach((li, i) => {
        const link = li.querySelector(':scope > a');
        const sub = li.querySelector(':scope > .submenu');
        if (!link || !sub) return;
        if (!sub.id) sub.id = `submenu-${i+1}`;
        link.setAttribute('aria-haspopup', 'true');
        link.setAttribute('aria-expanded', 'false');

        // Add hover delay to prevent immediate closing
        li.addEventListener('mouseleave', () => {
          if (isDesktopLayout()) {
            hoverTimeout = setTimeout(() => {
              // Only close if not hovering over any submenu
              if (!li.matches(':hover')) {
                closeTap(li);
              }
            }, 150); // Small delay
          }
        });
        
        li.addEventListener('mouseenter', () => {
          if (hoverTimeout) {
            clearTimeout(hoverTimeout);
            hoverTimeout = null;
          }
        });

        // Mobile-only toggle (+) — in DOM, hidden on desktop via CSS
        const btn = document.createElement('button');
        btn.className = 'submenu-toggle';
        btn.type = 'button';
        btn.setAttribute('aria-controls', sub.id);
        btn.setAttribute('aria-expanded', 'false');
        btn.setAttribute('aria-label', `${link.textContent?.trim() || 'Undermeny'} – expandera`);
        btn.innerHTML = '<span class="icon" aria-hidden="true">+</span>';
        li.insertBefore(btn, sub);

        // Mobile accordion: height-to-auto animation (no leaks)
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const expanding = !li.classList.contains('expanded');
          if (expanding) expandBranch(li);
          else collapseBranch(li);
        });

        // Touch-first desktop: first tap opens instead of navigating
        link.addEventListener('click', (ev) => {
          if (isDesktopLayout() && isTouchPrimary()) {
            const opened = li.classList.contains('open');
            if (!opened) {
              ev.preventDefault();
              closeSiblingsTap(li);
              openTap(li);
              ensureFlipToFit(li);
            }
          }
        });

        // Keyboard helpers
        link.addEventListener('keydown', (ev) => {
          if (ev.key === 'ArrowRight') {
            openTap(li); ensureFlipToFit(li);
            const first = sub?.querySelector('.menu-item > a');
            if (first) { ev.preventDefault(); first.focus(); }
          }
          if ((ev.key === 'Enter' || ev.key === ' ') && isMobile()) {
            ev.preventDefault();
            btn.click();
          }
          if (ev.key === 'ArrowDown' && !isMobile()) {
            ev.preventDefault();
            openTap(li); ensureFlipToFit(li);
            sub?.querySelector('.menu-item > a')?.focus();
          }
        });

        // Desktop hover/focus: whenever submenu is about to show, evaluate flip
        li.addEventListener('pointerenter', () => { 
          if (isDesktopLayout()) {
            ensureFlipToFit(li);
            setupScrollArrows(li);
          }
        });
        li.addEventListener('focusin', () => { 
          if (isDesktopLayout()) {
            ensureFlipToFit(li);
            setupScrollArrows(li);
          }
        });
      });

      // Hamburger open/close (mobile panel)
      const setOpen = (on) => {
        toggle.setAttribute('aria-expanded', String(on));
        header.classList.toggle('nav-open', on);
        backdrop.hidden = !on;
        document.body.style.overflow = on ? 'hidden' : '';
        if (!on) {
          // collapse all expanded on mobile
          menu.querySelectorAll('.expanded').forEach(collapseBranch);
        }
      };
      toggle?.addEventListener('click', () => {
        const open = toggle.getAttribute('aria-expanded') === 'true';
        setOpen(!open);
      });
      backdrop?.addEventListener('click', () => setOpen(false));
      window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { setOpen(false); closeAllTap(); } });

      // Close touch-open dropdowns on outside click (desktop)
      document.addEventListener('click', (e) => {
        if (!(e.target instanceof Element)) return;
        if (isDesktopLayout() && !e.target.closest('.main-nav')) closeAllTap();
        if (header.classList.contains('nav-open') && e.target.closest('.main-nav a')) setOpen(false);
      });

      // Reset states on layout changes
      mqMobile.addEventListener('change', () => { setOpen(false); closeAllTap(); });

      // ---- Mobile height animation helpers ----
      function expandBranch(li) {
        const link = li.querySelector(':scope > a');
        const btn  = li.querySelector(':scope > .submenu-toggle');
        const sub  = li.querySelector(':scope > .submenu');
        if (!sub) return;

        li.classList.add('expanded');
        link && link.setAttribute('aria-expanded', 'true');
        btn  && btn.setAttribute('aria-expanded', 'true');

        // Start from current height, animate to target, then set auto
        const start = sub.getBoundingClientRect().height;
        sub.style.height = start + 'px';
        requestAnimationFrame(() => {
          const target = sub.scrollHeight;
          sub.style.height = target + 'px';
        });
        const onEnd = (ev) => {
          if (ev.propertyName !== 'height') return;
          sub.style.height = 'auto';
        };
        sub.addEventListener('transitionend', onEnd, { once: true });

        // Keep section in view
        setTimeout(() => sub.scrollIntoView({ block: 'nearest', behavior: 'smooth' }), 60);
      }

      function collapseBranch(li) {
        const link = li.querySelector(':scope > a');
        const btn  = li.querySelector(':scope > .submenu-toggle');
        const sub  = li.querySelector(':scope > .submenu');
        if (!sub) return;

        // Collapse descendants first
        li.querySelectorAll(':scope .expanded').forEach(child => {
          child.classList.remove('expanded');
          const cSub = child.querySelector(':scope > .submenu');
          const cLink = child.querySelector(':scope > a');
          const cBtn  = child.querySelector(':scope > .submenu-toggle');
          cLink && cLink.setAttribute('aria-expanded', 'false');
          cBtn  && cBtn.setAttribute('aria-expanded', 'false');
          if (cSub) { cSub.style.height = '0px'; }
        });

        // Animate to 0
        const current = sub.scrollHeight;
        sub.style.height = current + 'px';
        // force reflow
        sub.offsetHeight;
        sub.style.height = '0px';

        li.classList.remove('expanded');
        link && link.setAttribute('aria-expanded', 'false');
        btn  && btn.setAttribute('aria-expanded', 'false');
      }

      // ---- Desktop: touch-open and flip helpers ----
      function openTap(li) {
        const link = li.querySelector(':scope > a');
        if (!li.classList.contains('open')) {
          closeSiblingsTap(li);
          li.classList.add('open');
          link?.setAttribute('aria-expanded', 'true');
          // Setup scroll arrows for large menus when opened
          setupScrollArrows(li);
        }
      }
      function closeTap(li) {
        const link = li.querySelector(':scope > a');
        li.classList.remove('open');
        li.classList.remove('open-left');
        link?.setAttribute('aria-expanded', 'false');
        li.querySelectorAll(':scope .open').forEach(n => { n.classList.remove('open'); n.classList.remove('open-left'); });
      }
      function closeAllTap() { menu.querySelectorAll('.open').forEach(closeTap); }
      function closeSiblingsTap(li) {
        const parent = li.parentElement;
        if (!parent) return;
        parent.querySelectorAll(':scope > .menu-item.open').forEach(sib => { if (sib !== li) closeTap(sib); });
      }

      // Compute if submenu should flip left to stay in viewport
      function ensureFlipToFit(li) {
        if (!isDesktopLayout()) return;
        const sub = li.querySelector(':scope > .submenu');
        if (!sub) return;

        // Wait for CSS to show it, then measure
        requestAnimationFrame(() => {
          const wasHidden = getComputedStyle(sub).display === 'none';
          if (wasHidden) {
            sub.style.visibility = 'hidden';
            sub.style.display = 'block';
          }
          requestAnimationFrame(() => {
            const rect = sub.getBoundingClientRect();
            const rightOverflow = rect.right > (window.innerWidth - 8);
            const leftOverflow = rect.left < 8;

            // Flip to left if it overflows on the right, otherwise keep default
            if (rightOverflow && !leftOverflow) {
              li.classList.add('open-left');
            } else {
              li.classList.remove('open-left');
            }

            if (wasHidden) {
              sub.style.display = '';
              sub.style.visibility = '';
            }
          });
        });
      }

      // Setup scroll arrows for large menus
      function setupScrollArrows(li) {
        const sub = li.querySelector(':scope > .submenu.large-menu');
        const scrollContainer = li.querySelector(':scope > .submenu.large-menu .menu-items-container');
        if (!sub || !scrollContainer) return;

        let scrollArrowsSetup = false;

        const setupArrowHandlers = () => {
          if (scrollArrowsSetup) return;
          scrollArrowsSetup = true;

          // Handle scroll arrow clicks - click on arrows in the submenu container
          const handleArrowClick = (e) => {
            const rect = sub.getBoundingClientRect();
            const clickY = e.clientY - rect.top;
            
            if (clickY <= 20) {
              // Up arrow clicked
              scrollContainer.scrollBy({ top: -100, behavior: 'smooth' });
            } else if (clickY >= rect.height - 20) {
              // Down arrow clicked  
              scrollContainer.scrollBy({ top: 100, behavior: 'smooth' });
            }
          };

          // Update arrow visibility based on scroll position of inner container
          const updateArrowVisibility = () => {
            const atTop = scrollContainer.scrollTop <= 5;
            const atBottom = scrollContainer.scrollTop >= scrollContainer.scrollHeight - scrollContainer.clientHeight - 5;
            
            sub.classList.toggle('at-top', atTop);
            sub.classList.toggle('at-bottom', atBottom);
          };

          sub.addEventListener('click', handleArrowClick);
          scrollContainer.addEventListener('scroll', updateArrowVisibility);
          
          // Initial arrow state
          updateArrowVisibility();
        };

        // Setup arrows when menu becomes visible
        if (getComputedStyle(sub).display !== 'none') {
          setupArrowHandlers();
        } else {
          // Wait for menu to become visible
          const observer = new MutationObserver(() => {
            if (getComputedStyle(sub).display !== 'none') {
              setupArrowHandlers();
              observer.disconnect();
            }
          });
          observer.observe(sub, { attributes: true, attributeFilter: ['style'] });
        }
      }
    })();
  </script>
</body>
</html>
