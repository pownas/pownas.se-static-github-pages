<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Investera eller amortera? (Korrigerad version)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --bg: #121212;
      --panel: #1E1E1E;
      --border: #444444;
      --text: #E0E0E0;
      --muted: #A0A0A0;
      --focus: #007BFF;
      --blue-btn: #0056b3;
    }
    html, body {
      background-color: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      margin: 0;
      font-size: 16px;
      line-height: 1.6;
    }
    header { padding: 24px 20px 12px; }
    h1 { font-size: 1.8rem; margin: 0 0 8px; }
    .sub { color: var(--muted); font-size: 1rem; max-width: 80ch; }
    .wrap {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      padding: 16px 20px 40px;
    }
    @media (max-width: 1024px) { .wrap { grid-template-columns: 1fr; } }
    .card {
      background-color: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .form { padding: 20px; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr 1fr; }
    label { font-size: 0.9rem; color: var(--muted); display:block; margin-bottom: 6px; }
    input[type="number"] {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 1rem;
      outline: none;
    }
    input[type="number"]:focus-visible {
      outline: 3px solid var(--focus);
      outline-offset: 1px;
    }
    .help { font-size: 0.8rem; color: var(--muted); margin-top: 4px;}
    .row { display: flex; gap: 12px; align-items: center; margin-top: 20px; }
    .btn {
      background-color: var(--blue-btn);
      color: #FFFFFF; border: 0; border-radius: 8px;
      padding: 12px 16px; cursor: pointer; font-weight: 600;
      font-size: 1rem;
    }
    .btn:focus-visible { outline: 3px solid var(--focus); outline-offset: 2px; }
    .btn.secondary { background-color: #383838; }
    .summary { padding: 16px; border-top: 1px solid var(--border); }
    #recommendation p { margin-top: 0; font-size: 1.1rem; }
    .kpis { display: grid; grid-template-columns: repeat(2,1fr); gap: 12px; margin-top: 16px; }
    .kpi {
      background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 12px;
    }
    .kpi h4 { margin: 0; font-size: 0.9rem; color: var(--muted); font-weight: 500; }
    .kpi p { margin: 4px 0 0; font-size: 1.4rem; font-weight: 700; }
    .kpi small { color: var(--muted); font-weight: 500; font-size: 1rem; }
    .good { color: #28a745; } /* Bright Green */
    .bad { color: #dc3545; }  /* Bright Red */
    .warn { color: #ffc107; } /* Bright Yellow */
    .charts { padding: 12px; }
    .chart-card { padding: 16px; margin-bottom: 20px; }
    canvas { width: 100%; height: 380px; }
    footer { color: var(--muted); font-size: 0.85rem; padding: 20px; text-align: center; }
  </style>
</head>
<body>
  <header>
    <h1>Investera eller amortera?</h1>
    <div class="sub">Jämför två strategier med garanterat högkontrasterande grafer. Grundvärdena matchar din graf.</div>
  </header>

  <div class="wrap">
    <section class="card form">
      <!-- Formuläret är oförändrat -->
      <div class="grid">
        <div>
          <label for="loan">Bolån (kr)</label>
          <input id="loan" type="number" value="1500000" min="0" step="1000">
        </div>
        <div>
          <label for="amortYear">Årlig grundamortering (kr)</label>
          <input id="amortYear" type="number" value="30000" min="0" step="1000">
        </div>
        <div>
          <label for="extraYear">Årligt extra belopp (kr)</label>
          <input id="extraYear" type="number" value="30000" min="0" step="1000">
        </div>
        <div>
          <label for="years">Antal år</label>
          <input id="years" type="number" value="30" min="1" max="60" step="1">
        </div>
        <div>
          <label for="loanRate">Bolåneränta p.a. (%)</label>
          <input id="loanRate" type="number" value="4" step="0.05" min="0">
        </div>
        <div>
          <label for="invRate">Avkastning p.a. (%)</label>
          <input id="invRate" type="number" value="5" step="0.05" min="0">
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="grid">
        <div>
          <label for="taxDeduct">Räntereduktion (%)</label>
          <input id="taxDeduct" type="number" value="30" step="1" min="0" max="100">
          <div class="help">T.ex. 30% upp till 100 tkr räntor.</div>
        </div>
        <div>
          <label for="taxInv">Skatt på avkastning (%)</label>
          <input id="taxInv" type="number" value="0" step="0.1" min="0" max="100">
          <div class="help">Förenklat: direkt skatt på avkastning.</div>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="run">Uppdatera beräkning</button>
        <button class="btn secondary" id="reset">Återställ</button>
      </div>
      <div class="summary">
        <div id="recommendation"></div>
        <div class="kpis">
          <div class="kpi"><h4>Effektiv ränta</h4><p><span id="effLoanRate"></span> <small>%</small></p></div>
          <div class="kpi"><h4>Effektiv avkastning</h4><p><span id="effInvRate"></span> <small>%</small></p></div>
          <div class="kpi"><h4>Skuldfri (Amortera)</h4><p><span id="monthsToZero"></span> <small>år</small></p></div>
          <div class="kpi"><h4>Brytpunkt avkast.</h4><p><span id="breakeven"></span> <small>%</small></p></div>
        </div>
      </div>
    </section>

    <section class="charts">
      <div class="card chart-card"><canvas id="netChart"></canvas></div>
      <div class="card chart-card"><canvas id="loanChart"></canvas></div>
      <div class="card chart-card"><canvas id="investChart"></canvas></div>
    </section>
  </div>

  <footer>
    Ansvarsfriskrivning: Detta är en förenklad modell. Beräkningar sker månadsvis med rak amortering. Inflation och ränteändringar beaktas inte. Historisk avkastning är ingen garanti för framtida avkastning.
  </footer>

  <script>
    // Simuleringslogiken är oförändrad
    const fmtK = v => v.toLocaleString('sv-SE', {maximumFractionDigits:0});
    const yrs = m => (m/12).toFixed(1);

    function simulate(params){
      const { P0, amortYear, extraYear, years, loanRate, invRate, taxDeduct, taxInv } = params;
      const months = Math.round(years * 12);
      const rLoan = (loanRate * (1 - taxDeduct/100)) / 12 / 100;
      const rInv  = (invRate  * (1 - taxInv/100))   / 12 / 100;
      const amortM = amortYear / 12;
      const extraM = extraYear / 12;
      const cashflowM = amortM + extraM;
      let loanA = P0, invA = 0, intAccA = 0;
      const loanSeriesA = [], invSeriesA = [], netSeriesA = [], intSeriesA = [];
      let loanB = P0, invB = 0, intAccB = 0;
      const loanSeriesB = [], invSeriesB = [], netSeriesB = [], intSeriesB = [];
      let monthsToZero = null;
      for(let m=0; m<=months; m++){
        loanSeriesA.push(loanA); invSeriesA.push(invA); intSeriesA.push(intAccA); netSeriesA.push(invA + (P0 - loanA));
        loanSeriesB.push(loanB); invSeriesB.push(invB); intSeriesB.push(intAccB); netSeriesB.push(invB + (P0 - loanB));
        if(m===months) break;
        if(loanA > 0){
          const iA = loanA * rLoan; intAccA += iA;
          loanA = Math.max(0, loanA + iA - Math.min(amortM, loanA));
        }
        invA = invA * (1 + rInv) + extraM;
        if(loanB > 0){
          const iB = loanB * rLoan; intAccB += iB;
          loanB = Math.max(0, loanB + iB - Math.min(cashflowM, loanB));
          if(loanB === 0 && monthsToZero === null) monthsToZero = m+1;
        } else {
          invB = invB * (1 + rInv) + cashflowM;
        }
        if(loanB > 0){ invB = invB * (1 + rInv); }
      }
      const labels = Array.from({length: years + 1}, (_, y) => `${y} år`);
      const yearly = s => Array.from({length: years + 1}, (_, y) => s[Math.min(s.length-1, Math.round(y*12))]);
      return {
        labels,
        A: { loan: yearly(loanSeriesA), invest: yearly(invSeriesA), net: yearly(netSeriesA), interest: yearly(intSeriesA), end: { net: netSeriesA.at(-1) } },
        B: { loan: yearly(loanSeriesB), invest: yearly(invSeriesB), net: yearly(netSeriesB), interest: yearly(intSeriesB), end: { net: netSeriesB.at(-1) } },
        monthsToZero,
        eff: { rLoanPa: rLoan*12*100, rInvPa: rInv*12*100 }
      };
    }
    function breakevenReturn(params){
      let lo = 0, hi = 25;
      for(let i=0;i<40;i++){
        const mid = (lo+hi)/2;
        const res = simulate({...params, invRate: mid, taxInv: 0});
        if (res.A.end.net > res.B.end.net) hi = mid; else lo = mid;
      }
      return (lo+hi)/2;
    }
    
    const charts = {};

    function buildOrUpdateCharts(model){
      const { labels, A, B } = model;
      
      // KORRIGERING: Hårdkodade högkontrasterande färger för graferna
      const datasets = {
        net: [
          { label: 'Netto – Investera extra', data: A.net, borderColor: '#33A0FF', borderWidth: 3, tension:.1 },
          { label: 'Netto – Amortera extra', data: B.net, borderColor: '#FFB000', borderWidth: 3, tension:.1 }
        ],
        loan: [
          { label: 'Skuld – Investera', data: A.loan, borderColor: '#33A0FF', borderWidth: 3, tension:.1 },
          { label: 'Skuld – Amortera', data: B.loan, borderColor: '#FFB000', borderWidth: 3, tension:.1 }
        ],
        invest: [
          { label: 'Kapital – Investera', data: A.invest, borderColor: '#4CBB17', borderWidth: 3, tension:.1 },
          { label: 'Kapital – Amortera', data: B.invest, borderColor: '#F038A0', borderWidth: 3, tension:.1 },
          { label: 'Ränta – Investera', data: A.interest, borderColor: '#A0A0A0', borderWidth: 2, borderDash:[5,5], tension:.1 },
          { label: 'Ränta – Amortera', data: B.interest, borderColor: '#B284BE', borderWidth: 2, borderDash:[5,5], tension:.1 }
        ]
      };
      const titles = { net: 'Nettoförmögenhet (Kapital + Amorterat)', loan: 'Kvarvarande skuld', invest: 'Kapitalvärde och ackumulerad ränta' };

      for (const key of ['net', 'loan', 'invest']) {
        if (charts[key]) {
          charts[key].data.labels = labels;
          charts[key].data.datasets.forEach((d, i) => d.data = datasets[key][i].data);
          charts[key].update();
        } else {
          charts[key] = new Chart(document.getElementById(`${key}Chart`), {
            type: 'line',
            data: { labels, datasets: datasets[key] },
            options: {
              responsive: true, interaction: { mode: 'index', intersect: false },
              scales: {
                y: { 
                  ticks: { color: '#C0C0C0', font: { size: 14 } }, 
                  grid: { color: 'rgba(255, 255, 255, 0.15)' } 
                },
                x: { 
                  ticks: { color: '#C0C0C0', maxRotation: 0, autoSkip: true, font: { size: 14 }}, 
                  grid: { color: 'rgba(255, 255, 255, 0.05)' } 
                }
              },
              plugins: {
                legend: { labels: { color: '#E0E0E0', font: { size: 14 } } },
                title: { display: true, text: titles[key], color: '#FFFFFF', font: { size: 18, weight: 'bold' } },
                tooltip: { 
                  titleFont: { size: 14 }, bodyFont: { size: 14 },
                  callbacks: { label: ctx => `${ctx.dataset.label}: ${fmtK(ctx.parsed.y)} kr` } 
                }
              }
            }
          });
        }
      }
    }

    function run() {
      const params = {
        P0: parseFloat(document.getElementById('loan').value) || 0,
        amortYear: parseFloat(document.getElementById('amortYear').value) || 0,
        extraYear: parseFloat(document.getElementById('extraYear').value) || 0,
        years: parseInt(document.getElementById('years').value) || 1,
        loanRate: parseFloat(document.getElementById('loanRate').value) || 0,
        invRate: parseFloat(document.getElementById('invRate').value) || 0,
        taxDeduct: parseFloat(document.getElementById('taxDeduct').value) || 0,
        taxInv: parseFloat(document.getElementById('taxInv').value) || 0,
      };

      const model = simulate(params);
      buildOrUpdateCharts(model);

      document.getElementById('effLoanRate').textContent = model.eff.rLoanPa.toFixed(2);
      document.getElementById('effInvRate').textContent = model.eff.rInvPa.toFixed(2);
      document.getElementById('monthsToZero').textContent = model.monthsToZero ? yrs(model.monthsToZero) : '>';
      document.getElementById('breakeven').textContent = breakevenReturn(params).toFixed(2);

      const diff = model.A.end.net - model.B.end.net;
      const recEl = document.getElementById('recommendation');
      if (Math.abs(diff) < 1000) {
        recEl.innerHTML = `<p class="warn">Resultaten är nästan identiska. Välj baserat på din riskpreferens.</p>`;
      } else if (diff > 0) {
        recEl.innerHTML = `<p class="good"><b>Investera extra</b> ger bäst resultat med <b>${fmtK(diff)} kr</b> mer i nettoförmögenhet.</p>`;
      } else {
        recEl.innerHTML = `<p class="bad"><b>Amortera extra</b> ger bäst resultat med <b>${fmtK(-diff)} kr</b> mer i nettoförmögenhet.</p>`;
      }
    }
    
    document.getElementById('run').addEventListener('click', run);
    document.getElementById('reset').addEventListener('click', () => {
        document.getElementById('loan').value = 1500000;
        document.getElementById('amortYear').value = 30000;
        document.getElementById('extraYear').value = 30000;
        document.getElementById('years').value = 30;
        document.getElementById('loanRate').value = 4;
        document.getElementById('invRate').value = 5;
        document.getElementById('taxDeduct').value = 30;
        document.getElementById('taxInv').value = 0;
        run();
    });

    document.addEventListener('DOMContentLoaded', run);
  </script>
</body>
</html>
